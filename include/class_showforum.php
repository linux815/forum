<?phpinclude_once('include/class_base.php');include_once('include/class_database.php');include_once('include/class_user.php');//// Конттроллер страницы чтения.//class C_ShowForum extends C_Base{	private $array_threads;	// Массив форумов	public $user; // Пользователи	public $online; // Количество пользователей в онлайн	public $online_user; // Кто в онлайн    private $i; // Счетчик    private $forum_id;    private $count_thread;    private $count_posts;    private $num;    private $pervpage;    private $page2left;    private $page1left;    private $page;    private $page1right;    private $page2right;    private $nextpage;      private $last_post;  	private $post;	private $array_forums;	// Массив форумов	private $count;	//	// Конструктор.	//	function __construct()	{		session_start();			}		//	// Виртуальный обработчик запроса.	//	protected function OnInput()	{				$database = new Database();		parent::OnInput();		$this->title = $this->title . ' :: Список тем';						// Менеджеры.		$mUsers = M_Users::Instance();				// Очистка старых сессий.		$mUsers->ClearSessions();				// Текущий пользователь.		$this->user = $mUsers->Get();				$this->online_user = $mUsers->Can();				if ($this->online_user == "") echo $this->online_user = "";		else {		// Сколько пользователей в онлайн		foreach($mUsers->Can() as $online) 		{			$this->i++;		}				$this->online = $this->i;		}				// Кто в онлайне		$this->online_user = $mUsers->IsOnline();					$this->forum_id = $_GET['id'];		$this->array_forums = $database->forums_select_podforum($this->forum_id)->fetchAll();		$this->posts = $database->count_table($this->forum_id)->fetch();		if ($this->posts[0] == 0) echo "";		else {				// Извлекаем из URL текущую страницу  		$this->page = $_GET['page'];  		// Определяем общее число сообщений в базе данных 				// Количество тем		$posts = $database->count_table($this->forum_id)->fetch();		if ($posts[0] < 3) $this->num = $posts[0]; else $this->num = 3;   		// Находим общее число страниц  		$total = intval(($posts[0] - 1) / $this->num) + 1;  		// Определяем начало сообщений для текущей страницы  		$this->page = intval($this->page);  		// Если значение $page меньше единицы или отрицательно  		// переходим на первую страницу  		// А если слишком большое, то переходим на последнюю  		if(empty($this->page) or $this->page < 0) $this->page = 1;    		if($this->page > $total) $this->page = $total;  		// Вычисляем начиная к какого номера  		// следует выводить сообщения  		$start = $this->page * $this->num - $this->num;  		// Выбираем $num сообщений начиная с номера $start  		// В цикле переносим результаты запроса в массив $postrow							// Выборка тем		$this->array_threads = $database->thread_select($this->forum_id, $start, $this->num)->fetchAll();		// Проверяем нужны ли стрелки назад  		if ($this->page != 1) $this->pervpage = '<a href= index.php?c=showforum&id='.$_GET['id'].'&page=1><<</a>                                       <a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page - 1) .'><</a> ';  		// Проверяем нужны ли стрелки вперед  		if ($this->page != $total) $this->nextpage = ' <a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page + 1) .'>></a>          		                           <a href= index.php?c=showforum&id='.$_GET['id'].'&page=' .$total. '>>></a>';  		// Находим две ближайшие станицы с обоих краев, если они есть  		if($this->page - 2 > 0) $this->page2left = ' <a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page - 2) .'>'. ($this->page - 2) .'</a> | ';  		if($this->page - 1 > 0) $this->page1left = '<a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page - 1) .'>'. ($this->page - 1) .'</a> | ';  		if($this->page + 2 <= $total) $this->page2right = ' | <a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page + 2) .'>'. ($this->page + 2) .'</a>';  		if($this->page + 1 <= $total) $this->page1right = ' | <a href= index.php?c=showforum&id='.$_GET['id'].'&page='. ($this->page + 1) .'>'. ($this->page + 1) .'</a>'; 			}	}		//	// Виртуальный генератор HTML.	//		protected function OnOutput()	{		$vars = array('array_forums' => $this->array_forums, 'array_threads' => $this->array_threads, 'user' => $this->user, 'online' => $this->online, 'online_user' => $this->online_user, 'array_podforums' => $this->array_podforums, 'count_thread' => $this->count_thread, 'num' => $this->num, 'pervpage' => $this->pervpage, 'page2left' => $this->page2left, 'page1left' => $this->page1left, 'page' => $this->page, 'page1right' => $this->page1right, 'page2right' => $this->page2right, 'nextpage' => $this->nextpage, 'last_post' => $this->last_post, 'posts' => $this->posts, 'count' => $this->count);			$this->content = $this->Template('templates/v_showforum.php', $vars);		parent::OnOutput();	}	}