<?phpinclude_once('include/class_base.php');include_once('include/class_database.php');include_once('include/class_user.php');//// Конттроллер страницы чтения.//class C_ShowMessage extends C_Base{	private $array_messages;	// Массив cообщений	public $user; // Пользователи	public $online; // Количество пользователей в онлайн	public $online_user; // Кто в онлайн    private $i; // Счетчик    private $thread_id;    private $array_thread;    private $num;    private $pervpage;    private $page2left;    private $page1left;    private $page;    private $page1right;    private $page2right;    private $nextpage;	//	// Конструктор.	//	function __construct()	{		session_start();			}		//	// Виртуальный обработчик запроса.	//	protected function OnInput()	{				$database = new Database();		parent::OnInput();		$this->title = $this->title . ' :: Посты';						// Менеджеры.		$mUsers = M_Users::Instance();				// Очистка старых сессий.		$mUsers->ClearSessions();				// Текущий пользователь.		$this->user = $mUsers->Get();		$this->online_user = $mUsers->Can();				if ($this->online_user == "") {echo $this->online_user = ""; }		else {		// Сколько пользователей в онлайн		foreach($mUsers->Can() as $online) 		{			$this->i++;		}				$this->online = $this->i;		}		// Кто в онлайне		$this->online_user = $mUsers->IsOnline();					$this->thread_id = $_GET['id'];				$database->view_count($this->thread_id);		$this->array_thread = $database->thread_select_thread($this->thread_id);		 		if (isset($_POST['other']))		{			$_SESSION['text'] = $_POST['text'];			header('Location: index.php?c=addpost&forums='.$_GET['forums'].'&id='.$_GET['id']);			die();					}				if (isset($_POST['submitForm']))		{				$thread_id = $_GET['id'];			$forum_id = $_GET['forums'];			$header = "";			$post_text = $_POST['text'];			if ($this->user[0] <> "") 			{				// удачная отправка формы				$database->posts_insert($thread_id, $header, $this->user['id_user'], $post_text);				$database->forum_update_last($this->user['id_user'], $this->user['name'], $thread_id);				$database->forum_update_last2($this->user['id_user'], $this->user['name'], $forum_id, $thread_id);								unset($_SESSION['text']);				unset($_SESSION['quote']);								header('Location: index.php?c=showmessage&forums='.$forum_id.'&id='.$thread_id.'&page=1');				die();					} else echo "";			} else "";				 		// Извлекаем из URL текущую страницу  		$this->page = $_GET['page'];  		// Определяем общее число сообщений в базе данных  		$posts = $database->post_count($this->thread_id)->fetch();		if ($posts[0] < 3) $this->num = $posts[0]; else $this->num = 3;    		// Находим общее число страниц  		@$total = intval(($posts[0] - 1) / $this->num) + 1;  		// Определяем начало сообщений для текущей страницы  		@$this->page = intval($this->page);  		// Если значение $page меньше единицы или отрицательно  		// переходим на первую страницу  		// А если слишком большое, то переходим на последнюю  		if(empty($this->page) or $this->page < 0) $this->page = 1;    		if($this->page > $total) $this->page = $total;  		// Вычисляем начиная к какого номера  		// следует выводить сообщения  		@$start = $this->page * $this->num - $this->num;  		// Выбираем $num сообщений начиная с номера $start  		// В цикле переносим результаты запроса в массив $postrow  						// Выборка сообщений		@$this->array_messages = $database->post_select($this->thread_id, $start, $this->num)->fetchAll();			// Проверяем нужны ли стрелки назад  		if ($this->page != 1) $this->pervpage = '<a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page=1><<</a>                                       <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page - 1) .'><</a> ';  		// Проверяем нужны ли стрелки вперед  		if ($this->page != $total) $this->nextpage = ' <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page + 1) .'>></a>          		                           <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page=' .$total. '>>></a>';  		// Находим две ближайшие станицы с обоих краев, если они есть  		if($this->page - 2 > 0) $this->page2left = ' <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page - 2) .'>'. ($this->page - 2) .'</a> | ';  		if($this->page - 1 > 0) $this->page1left = '<a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page - 1) .'>'. ($this->page - 1) .'</a> | ';  		if($this->page + 2 <= $total) $this->page2right = ' | <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page + 2) .'>'. ($this->page + 2) .'</a>';  		if($this->page + 1 <= $total) $this->page1right = ' | <a href= index.php?c=showmessage&forums='.$_GET['forums'].'&id='.$_GET['id'].'&page='. ($this->page + 1) .'>'. ($this->page + 1) .'</a>'; 		    	}		//	// Виртуальный генератор HTML.	//		protected function OnOutput()	{		$vars = array('array_messages' => $this->array_messages, 'user' => $this->user, 'online' => $this->online, 'online_user' => $this->online_user, 'array_podforums' => $this->array_podforums, 'array_thread' => $this->array_thread, 'num' => $this->num, 'pervpage' => $this->pervpage, 'page2left' => $this->page2left, 'page1left' => $this->page1left, 'page' => $this->page, 'page1right' => $this->page1right, 'page2right' => $this->page2right, 'nextpage' => $this->nextpage);			$this->content = $this->Template('templates/v_showmessage.php', $vars);		parent::OnOutput();	}	}