<?phpuse JBBCode\Parser;use JBBCode\DefaultCodeDefinitionSet;// Загружаем смайлики$pak = file('templates/smilies/Set_Smiles_YarNET.pak');$smiles = [];foreach ($pak as $val) {    $val = trim($val);    if ($val === '' || $val[0] === '#') {        continue;    }    [$gif, $alt, $symbol] = explode('=+:', $val);    $smiles[$symbol] = '<img src="templates/smilies/' . htmlspecialchars($gif) . '" alt="' . htmlspecialchars($alt) . '" />';}function parse_bbcode_with_smileys(string $text, array $smiles): string{    $parser = new Parser();    $parser->addCodeDefinitionSet(new DefaultCodeDefinitionSet());    $parser->parse($text);    $html = $parser->getAsHtml();    return str_replace(array_keys($smiles), array_values($smiles), $html);}?><!DOCTYPE html><html lang="ru"><head>    <meta charset="UTF-8" />    <title>Сообщения</title>    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />    <style>        .ipbtable th, .ipbtable td {            vertical-align: middle;        }        .forumdesc {            white-space: pre-wrap;        }        .bbcode-post {            border: 1px solid #ddd;            padding: 15px;            border-radius: 5px;            background-color: #fafafa;        }    </style></head><body class="p-3"><?php if (!empty($user) && ($user != 0)): ?>    <div class="mb-3">        <a href="index.php?c=addpost&forums=<?= htmlspecialchars($_GET['forums'] ?? '') ?>&id=<?= htmlspecialchars($_GET['id'] ?? '') ?>" class="btn btn-primary">Добавить сообщение (Ответить)</a>    </div><?php endif; ?><div class="border p-3 mb-4" id="fo_1">    <table class="table table-bordered ipbtable">        <?php if (!empty($array_messages) && $array_messages[0] !== ""): ?>            <thead class="table-light">            <tr>                <th colspan="2" style="width:80%;">Ответы пользователей</th>                <th colspan="2">Информация о пользователе</th>            </tr>            </thead>        <?php endif; ?>        <tbody>        <tr>            <td colspan="4" class="fw-bold">Основной пост темы:</td>        </tr>        <?php foreach ($array_thread as $row2): ?>            <tr>                <td colspan="4">                    <div><small class="text-muted"><?= htmlspecialchars($row2['date']) ?></small></div>                    <div class="bbcode-post"><?= parse_bbcode_with_smileys($row2['text'], $smiles) ?></div>                    <hr />                </td>            </tr>        <?php endforeach; ?>        <?php if (!isset($_GET['showforum'])): ?>            <?php foreach ($array_messages as $key): ?>                <tr>                    <td class="text-center" style="width:1%;">                        <img src="images/norm.gif" alt="icon" />                    </td>                    <td>                        <div><small>Дата сообщения: <?= htmlspecialchars($key['post_date']) ?></small></div>                        <strong><?= htmlspecialchars($key['header']) ?></strong><br />                        <span class="forumdesc">                            <?= parse_bbcode_with_smileys($key['post_text'], $smiles) ?>                            <?php                            if (!isset($_GET['quote'])) {                                unset($_SESSION['quote']);                            }                            if (                                isset($_GET['quote']) &&                                $key['id_posts'] == $_GET['quote'] &&                                ($key['post_text'] ?? '') !== ($_SESSION['quote'] ?? '')                            ) {                                $_SESSION['quote'] = "[quote=" . $key['name'] . "]" . $key['post_text'] . "[/quote]\n";                            }                            ?>                            <br />                            <?php if (!empty($user) && ($user != 0)): ?>                                <a href="index.php?c=confirm&forums=<?= htmlspecialchars($_GET['forums'] ?? '') ?>&post=<?= $key['id_posts'] ?>&threads=<?= htmlspecialchars($_GET['id'] ?? '') ?>">Удалить</a> |                                <a href="index.php?c=editpost&post=<?= $key['id_posts'] ?>">Редактировать</a> |                                <a href="index.php?c=showmessage&forums=<?= htmlspecialchars($_GET['forums'] ?? '') ?>&id=<?= htmlspecialchars($_GET['id'] ?? '') ?>&page=<?= htmlspecialchars($_GET['page'] ?? '1') ?>&quote=<?= $key['id_posts'] ?>">Цитировать</a>                            <?php endif; ?>                        </span>                        <hr />                    </td>                    <td style="width:150px;">                        <img src="./images/<?= htmlspecialchars($key['avatar']) ?>" alt="avatar" class="img-thumbnail mb-2" />                        <div><?= htmlspecialchars($key['name']) ?></div>                    </td>                </tr>            <?php endforeach; ?>        <?php endif; ?>        </tbody>    </table></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script></body></html>