<?phpuse JBBCode\Parser;use JBBCode\DefaultCodeDefinitionSet;use JBBCode\CodeDefinitionBuilder;function parseBBCode(string $text): string {    $parser = new Parser();    $parser->addCodeDefinitionSet(new DefaultCodeDefinitionSet());    // Добавляем поддержку [quote] тега    $builder = new CodeDefinitionBuilder('quote', '<blockquote><b>{option}:</b> {param}</blockquote>');    $builder->setUseOption(true); // чтобы обрабатывать [quote=Иван]    $parser->addCodeDefinition($builder->build());    // Добавляем поддержку [s] — зачёркнутый текст    $sBuilder = new CodeDefinitionBuilder('s', '<del>{param}</del>');    $parser->addCodeDefinition($sBuilder->build());    $parser->parse($text);    return $parser->getAsHtml();}?><?php if ($user !== 0): ?>    <a href="index.php?c=addpost&forums=<?= $_GET['forums'] ?>&id=<?= $_GET['id'] ?>" class="btn btn-primary mt-3">Добавить сообщение (Ответить)</a><?php endif; ?><div class="container mt-4">    <div class="card">        <div class="card-header bg-light">            Основной пост темы:        </div>        <div class="card-body">            <?php foreach ($array_thread as $row2): ?>                <div class="mb-3">                    <small class="text-muted"><?= htmlspecialchars($row2['date']) ?></small>                    <div class="mt-2">                        <?= parseBBCode($row2['text']) ?>                    </div>                    <hr>                </div>            <?php endforeach; ?>        </div>    </div>    <?php if (!empty($array_messages)): ?>        <div class="card mt-4">            <div class="card-header bg-secondary text-white">Ответы пользователей</div>            <div class="table-responsive">                <table class="table table-bordered mb-0">                    <tbody>                    <?php foreach ($array_messages as $key): ?>                        <tr>                            <td width="5%" class="text-center align-middle"><img src="images/norm.gif" alt=""></td>                            <td width="65%">                                <strong><?= htmlspecialchars($key['header']) ?></strong><br>                                <small class="text-muted">Дата сообщения: <?= htmlspecialchars($key['post_date']) ?></small>                                <div class="mt-2">                                    <?= parseBBCode($key['post_text']) ?>                                </div>                                <?php                                if (!isset($_GET['quote'])) {                                    unset($_SESSION['quote']);                                }                                if (isset($_GET['quote']) && ($key['id_posts'] == $_GET['quote']) && ($key['post_text'] !== $_SESSION['quote'])) {                                    $_SESSION['quote'] = "[quote=" . $key['name'] . "]" . $key['post_text'] . "[/quote]\n";                                }                                ?>                                <?php if ($user !== 0): ?>                                    <div class="mt-2">                                        <a href="index.php?c=confirm&forums=<?= $_GET['forums'] ?>&post=<?= $key['id_posts'] ?>&threads=<?= $_GET['id'] ?>">Удалить</a> |                                        <a href="index.php?c=editpost&post=<?= $key['id_posts'] ?>">Редактировать</a> |                                        <a href="index.php?c=showmessage&forums=<?= $_GET['forums'] ?>&id=<?= $_GET['id'] ?>&page=<?= $_GET['page'] ?>&quote=<?= $key['id_posts'] ?>">Цитировать</a> |                                        <a href="javascript:pasteQ();" title="Для вставки цитаты в форму ответа, выделите ее, и нажмите сюда">Цитировать выделенное</a>                                    </div>                                <?php endif; ?>                            </td>                            <td width="30%" class="text-center align-middle">                                <img src="./images/<?= htmlspecialchars($key['avatar']) ?>" alt="Avatar" class="img-fluid rounded"><br>                                <?= htmlspecialchars($key['name']) ?>                            </td>                        </tr>                    <?php endforeach; ?>                    </tbody>                </table>            </div>        </div>    <?php endif; ?>    <?php if (!empty($user)): ?>        <div class="mt-3">            <?php            if (($page != 1 || $nextpage != "")) {                echo $pervpage . $page2left . $page1left . '<b>' . $page . '</b>' . $page1right . $page2right . $nextpage;            }            ?>        </div>    <?php endif; ?></div>